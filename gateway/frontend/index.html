<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <title>Adnan.AI / Evolia OS — CEO konzola</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #050816;
      color: #f5f5f5;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 60%);
    }

    .brand {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      opacity: 0.9;
    }

    main {
      flex: 1;
      padding: 16px 24px 24px 24px;
      display: grid;
      grid-template-columns: 2fr 3fr;
      grid-auto-rows: auto;
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.1);
      border: 1px solid rgba(45, 212, 191, 0.3);
      color: #5eead4;
    }

    .badge-danger {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(127, 29, 29, 0.2);
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    .kv-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      gap: 8px;
    }

    .kv-key {
      opacity: 0.6;
    }

    .kv-value {
      text-align: right;
      font-weight: 500;
    }

    .list-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.25);
      border: 1px solid rgba(129, 140, 248, 0.6);
      color: #c7d2fe;
    }

    .chip-soft {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    .approvals-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-pill {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.85);
      font-size: 11px;
    }

    .stat-label {
      opacity: 0.65;
      margin-bottom: 2px;
    }

    .stat-value {
      font-weight: 600;
    }

    .json-view {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre;
      overflow: auto;
      max-height: 260px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(30, 64, 175, 0.6);
      margin-top: 8px;
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    button {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
    }

    button:hover {
      border-color: rgba(129, 140, 248, 0.85);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-left: 6px;
    }

    .status-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .status-dot.bad {
      background: #dc2626;
      box-shadow: 0 0 8px rgba(220, 38, 38, 0.7);
    }

    .hint {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 4px;
    }

    .textarea {
      width: 100%;
      min-height: 72px;
      max-height: 180px;
      resize: vertical;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-family: inherit;
      font-size: 13px;
    }

    .textarea:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.9);
    }

    .cmd-status {
      font-size: 11px;
      margin-top: 6px;
      opacity: 0.8;
      white-space: pre-line;
    }

    .cmd-log {
      margin-top: 8px;
      font-family: "JetBrains Mono", ui-monospace;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
      display: none; /* debug detalji skriveni po defaultu */
    }

    .cmd-log.visible {
      display: block;
    }

    .goals-tasks-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 6px;
    }

    .summary-block-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .summary-pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .summary-pill {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    details.debug-toggle summary {
      font-size: 11px;
      opacity: 0.75;
      cursor: pointer;
      list-style: none;
    }

    details.debug-toggle summary::-webkit-details-marker {
      display: none;
    }

    details.debug-toggle summary::before {
      content: "▶";
      display: inline-block;
      margin-right: 6px;
      font-size: 9px;
      transform: translateY(-1px);
    }

    details.debug-toggle[open] summary::before {
      content: "▼";
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <span class="brand-title">Adnan.AI / Evolia OS</span>
        <span class="brand-subtitle">CEO konzola izvršnog direktora · Pregled sustava i ciljeva</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="pill" id="version-pill">v–</span>
        <span class="pill" id="channel-pill">–</span>
      </div>
    </header>

    <main>
      <!-- SUSTAV -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">SUSTAV</span>
          <span class="badge" id="boot-badge">
            BOOTING
            <span class="status-dot bad"></span>
          </span>
        </div>
        <div id="system-kv"></div>
        <div class="hint">Status operativnog sustava (verzija, zaključavanje arhitekture, mod rada).</div>
      </section>

      <!-- CJEVO VOD ODOBRENJA -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">CJEVO VOD ODOBRENJA</span>
          <span class="badge">BLOKIRANO → ODOBRENO → IZVRŠENO</span>
        </div>
        <div id="approvals-stats"></div>
        <div class="hint">Pregled koliko zahtjeva je na čekanju, odobreno i neuspješno.</div>
      </section>

      <!-- GOALS & TASKS PREGLED (READ-ONLY BIZNIS PANEL) -->
      <section class="card" style="grid-column: span 2;">
        <div class="card-header">
          <span class="card-title">GOALS & TASKS — PREGLED</span>
          <span class="badge">READ-ONLY SNAPSHOT</span>
        </div>
        <div class="goals-tasks-grid">
          <div>
            <div class="summary-block-title">CILJEVI (GOALS)</div>
            <div id="goals-summary" class="summary-pill-row"></div>
          </div>
          <div>
            <div class="summary-block-title">TASKOVI (TASKS)</div>
            <div id="tasks-summary" class="summary-pill-row"></div>
          </div>
        </div>
        <div class="hint">
          Agregiran pregled ciljeva i taskova po statusu/prioritetu. Ako nema podataka, backend još ne puni ovu sekciju.
        </div>
      </section>

      <!-- IDENTITET I MODA -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">IDENTITET I MODA</span>
        </div>
        <div id="identity-block"></div>
        <div id="mode-block" style="margin-top:10px;"></div>
      </section>

      <!-- CEO KOMANDA (NL → /api/execute) -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">CEO KOMANDA (NL)</span>
          <span class="badge-danger">GOVERNANCE ACTIVE</span>
        </div>
        <textarea
          id="ceo-input"
          class="textarea"
          placeholder="Upiši CEO komandu, npr:&#10;kreiraj task EVO-CEO-TASK-UI-001 priority High status Not Started due date 2026-01-15">
        </textarea>
        <div class="toolbar" style="justify-content:flex-start;margin-top:8px;">
          <button id="send-btn">Pošalji komandu (kreiraj zahtjev)</button>
          <button id="approve-btn">Odobri zadnji zahtjev</button>
          <button id="snapshot-btn">Osvježi pregled</button>
          <button id="toggle-log-btn">Prikaži tehničke detalje</button>
        </div>
        <div id="cmd-status" class="cmd-status"></div>
        <div id="cmd-log" class="cmd-log"></div>
        <div class="hint">
          Svaka komanda prolazi putanju CEO → BLOKIRANO → ODOBRENJE → IZVRŠEN0. Ovdje vidiš samo sažetak, detaljan JSON je u debug sekciji.
        </div>
      </section>

      <!-- TEHNIČKI SNIMAK (DEBUG) -->
      <section class="card" style="grid-column: span 2;">
        <div class="card-header">
          <span class="card-title">TEHNIČKI POGLED (DEBUG)</span>
          <div class="toolbar" style="margin-bottom:0;">
            <button id="refresh-btn">Osvježi snimku</button>
          </div>
        </div>
        <details class="debug-toggle">
          <summary>Prikaži tehnički JSON snimak sustava</summary>
          <div id="json-view" class="json-view">{}</div>
        </details>
      </section>
    </main>
  </div>

  <script>
    let lastApprovalId = null;
    let lastExecutionId = null;

    function safeString(v) {
      if (v === null || v === undefined) return "–";
      return String(v);
    }

    function renderSummaryPills(container, label, obj) {
      container.innerHTML = "";
      if (!obj || typeof obj !== "object" || Object.keys(obj).length === 0) {
        const pill = document.createElement("div");
        pill.className = "summary-pill";
        pill.textContent = "Nema agregiranih podataka";
        container.appendChild(pill);
        return;
    }

    const entries = Object.entries(obj);
    entries.forEach(([key, value]) => {
      const pill = document.createElement("div");
      pill.className = "summary-pill";
      pill.textContent = `${key}: ${value}`;
      container.appendChild(pill);
    });
  }

    async function loadSnapshot() {
      const jsonView = document.getElementById("json-view");
      const systemKv = document.getElementById("system-kv");
      const identityBlock = document.getElementById("identity-block");
      const modeBlock = document.getElementById("mode-block");
      const approvalsStats = document.getElementById("approvals-stats");
      const versionPill = document.getElementById("version-pill");
      const channelPill = document.getElementById("channel-pill");
      const bootBadge = document.getElementById("boot-badge");
      const goalsSummaryEl = document.getElementById("goals-summary");
      const tasksSummaryEl = document.getElementById("tasks-summary");

      jsonView.textContent = "Učitavam snimku…";

      try {
        const res = await fetch("/api/ceo/console/snapshot");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        jsonView.textContent = JSON.stringify(data, null, 2);

        const system = data.system || {};
        const identity = data.identity || {};
        const mode = data.mode || {};
        const approvals = data.approvals || {};
        const goalsSummaryData = data.goals_summary || null;
        const tasksSummaryData = data.tasks_summary || null;

        versionPill.textContent = `v${safeString(system.version)}`;
        channelPill.textContent = safeString(system.release_channel);

        const bootOk = !!system.boot_ready;
        bootBadge.innerHTML = bootOk
          ? 'SPREMAN<span class="status-dot ok"></span>'
          : 'BOOTING<span class="status-dot bad"></span>';

        systemKv.innerHTML = "";
        const kvPairs = [
          ["Ime", system.name],
          ["Verzija", system.version],
          ["Kanal izdanja", system.release_channel],
          ["Zaključana arhitektura", String(system.arch_lock)],
          ["OS omogućen", String(system.os_enabled)],
          ["OPS siguran način rada", String(system.ops_safe_mode)],
        ];
        kvPairs.forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "kv-row";
          row.innerHTML = `<span class="kv-key">${k}</span><span class="kv-value">${safeString(v)}</span>`;
          systemKv.appendChild(row);
        });

        identityBlock.innerHTML = "";
        const name = identity.name || "Adnan.AI";
        const role = identity.role || "";
        const essence = identity.essence || "";

        const titleRow = document.createElement("div");
        titleRow.className = "kv-row";
        titleRow.innerHTML = `<span class="kv-key">Identitet</span><span class="kv-value">${name}</span>`;
        identityBlock.appendChild(titleRow);

        if (role) {
          const roleRow = document.createElement("div");
          roleRow.className = "kv-row";
          roleRow.innerHTML = `<span class="kv-key">Uloga sustava</span><span class="kv-value">${role}</span>`;
          identityBlock.appendChild(roleRow);
        }

        if (essence) {
          const essRow = document.createElement("div");
          essRow.style.marginTop = "6px";
          essRow.style.fontSize = "11px";
          essRow.style.opacity = "0.8";
          essRow.textContent = essence;
          identityBlock.appendChild(essRow);
        }

        const values = Array.isArray(identity.values) ? identity.values : [];
        if (values.length > 0) {
          const chipsRow = document.createElement("div");
          chipsRow.className = "list-chip-row";
          values.forEach(v => {
            const chip = document.createElement("span");
            chip.className = "chip chip-soft";
            chip.textContent = v;
            chipsRow.appendChild(chip);
          });
          identityBlock.appendChild(chipsRow);
        }

        modeBlock.innerHTML = "";
        const currentMode = (data.state && data.state.current_mode) || mode.default_mode || "operational";
        const modeRow = document.createElement("div");
        modeRow.className = "kv-row";
        modeRow.innerHTML = `<span class="kv-key">Trenutni način rada</span><span class="kv-value">${currentMode}</span>`;
        modeBlock.appendChild(modeRow);

        const modes = mode.modes || {};
        const modeKeys = Object.keys(modes);
        if (modeKeys.length > 0) {
          const chipsRow = document.createElement("div");
          chipsRow.className = "list-chip-row";
          modeKeys.forEach(key => {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = key;
            chipsRow.appendChild(chip);
          });
          modeBlock.appendChild(chipsRow);
        }

        approvalsStats.innerHTML = "";
        const total = approvals.total ?? 0;
        const pendingCount = approvals.pending_count ?? 0;
        const completedCount = approvals.completed_count ?? 0;
        const failedCount = approvals.failed_count ?? 0;

        const grid = document.createElement("div");
        grid.className = "approvals-grid";

        [
          ["Ukupno", total],
          ["Na čekanju", pendingCount],
          ["Završeno", completedCount],
          ["Neuspješno", failedCount],
        ].forEach(([label, value]) => {
          const pill = document.createElement("div");
          pill.className = "stat-pill";
          pill.innerHTML = `<div class="stat-label">${label}</div><div class="stat-value">${value}</div>`;
          grid.appendChild(pill);
        });

        approvalsStats.appendChild(grid);

        // GOALS & TASKS SUMMARY (placeholder – čita iz data.goals_summary / data.tasks_summary ako postoje)
        let goalsStatus = null;
        let tasksStatus = null;

        if (goalsSummaryData && typeof goalsSummaryData === "object") {
          goalsStatus = goalsSummaryData.by_status || goalsSummaryData;
        }

        if (tasksSummaryData && typeof tasksSummaryData === "object") {
          tasksStatus = tasksSummaryData.by_status || tasksSummaryData;
        }

        renderSummaryPills(goalsSummaryEl, "Ciljevi", goalsStatus);
        renderSummaryPills(tasksSummaryEl, "Taskovi", tasksStatus);
      } catch (err) {
        jsonView.textContent = "Greška pri učitavanju snimke: " + err;
      }
    }

    async function sendCommand() {
      const input = document.getElementById("ceo-input");
      const statusEl = document.getElementById("cmd-status");
      const logEl = document.getElementById("cmd-log");
      const text = (input.value || "").trim();
      if (!text) {
        statusEl.textContent = "Unesi CEO komandu.";
        return;
      }

      statusEl.textContent = "Šaljem zahtjev kroz /api/execute…";
      logEl.textContent = "";

      try {
        const res = await fetch("/api/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });

        if (!res.ok) {
          const errText = await res.text();
          statusEl.textContent = "Greška: " + errText;
          return;
        }

        const data = await res.json();
        lastApprovalId = data.approval_id || null;
        lastExecutionId = data.execution_id || null;

        const state = data.execution_state || "";
        let human = "";

        if (state === "BLOCKED") {
          human = "Zadnja komanda je zabilježena i čeka tvoje odobrenje.";
        } else if (state === "COMPLETED") {
          human = "Zadnja komanda je izvršena.";
        } else {
          human = "Stanje zadnje komande: " + safeString(state);
        }

        statusEl.textContent =
          human +
          "\napproval_id: " + safeString(lastApprovalId) +
          "\nexecution_id: " + safeString(lastExecutionId);

        logEl.textContent = JSON.stringify(data, null, 2);

        await loadSnapshot();
      } catch (err) {
        statusEl.textContent = "Greška pri slanju komande: " + err;
      }
    }

    async function approveLast() {
      const statusEl = document.getElementById("cmd-status");
      const logEl = document.getElementById("cmd-log");

      if (!lastApprovalId) {
        statusEl.textContent = "Nema aktivnog zahtjeva za odobriti (prvo pošalji komandu).";
        return;
      }

      statusEl.textContent = "Odobravam kroz /api/ai-ops/approval/approve…";

      try {
        const res = await fetch("/api/ai-ops/approval/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ approval_id: lastApprovalId }),
        });

        if (!res.ok) {
          const errText = await res.text();
          statusEl.textContent = "Greška pri odobravanju: " + errText;
          return;
        }

        const data = await res.json();
        const state = data.execution_state || "";
        let human = "";

        if (state === "COMPLETED") {
          human = "Zahtjev je odobren i izvršen.";
        } else {
          human = "Stanje nakon odobravanja: " + safeString(state);
        }

        statusEl.textContent = human;
        logEl.textContent = JSON.stringify(data, null, 2);

        lastApprovalId = null;
        await loadSnapshot();
      } catch (err) {
        statusEl.textContent = "Greška pri odobravanju: " + err;
      }
    }

    function toggleLog() {
      const logEl = document.getElementById("cmd-log");
      const btn = document.getElementById("toggle-log-btn");
      if (logEl.classList.contains("visible")) {
        logEl.classList.remove("visible");
        btn.textContent = "Prikaži tehničke detalje";
      } else {
        logEl.classList.add("visible");
        btn.textContent = "Sakrij tehničke detalje";
      }
    }

    document.getElementById("send-btn").addEventListener("click", sendCommand);
    document.getElementById("approve-btn").addEventListener("click", approveLast);
    document.getElementById("refresh-btn").addEventListener("click", loadSnapshot);
    document.getElementById("snapshot-btn").addEventListener("click", loadSnapshot);
    document.getElementById("toggle-log-btn").addEventListener("click", toggleLog);

    loadSnapshot();
  </script>
</body>
</html>
