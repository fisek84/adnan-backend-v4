<!DOCTYPE html>
<html lang="bs">
<head>
  <meta charset="UTF-8" />
  <title>Adnan.AI / Evolia OS — CEO konzola</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #050816;
      color: #f5f5f5;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 60%);
    }

    .brand {
      display: flex;
      flex-direction: column;
    }

    .brand-title {
      font-size: 18px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }

    .brand-subtitle {
      font-size: 12px;
      opacity: 0.7;
    }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      opacity: 0.9;
    }

    main {
      flex: 1;
      padding: 16px 24px 24px 24px;
      display: grid;
      grid-template-columns: 2fr 3fr;
      grid-template-rows: auto auto auto;
      gap: 16px;
      align-items: flex-start;
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      padding: 14px 16px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
      backdrop-filter: blur(14px);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.85;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(15, 118, 110, 0.1);
      border: 1px solid rgba(45, 212, 191, 0.3);
      color: #5eead4;
    }

    .badge-danger {
      background: rgba(127, 29, 29, 0.2);
      border-color: rgba(248, 113, 113, 0.6);
      color: #fecaca;
    }

    .kv-row {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 4px;
      gap: 8px;
    }

    .kv-key {
      opacity: 0.6;
    }

    .kv-value {
      text-align: right;
      font-weight: 500;
    }

    .list-chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.25);
      border: 1px solid rgba(129, 140, 248, 0.6);
      color: #c7d2fe;
    }

    .chip-soft {
      background: rgba(15, 23, 42, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
      color: #e5e7eb;
    }

    .approvals-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-pill {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      background: rgba(15, 23, 42, 0.85);
      font-size: 11px;
    }

    .stat-label {
      opacity: 0.65;
      margin-bottom: 2px;
    }

    .stat-value {
      font-weight: 600;
    }

    .json-view {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre;
      overflow: auto;
      max-height: 260px;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(30, 64, 175, 0.6);
    }

    .toolbar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    button {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
    }

    button:hover {
      border-color: rgba(129, 140, 248, 0.85);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-left: 6px;
    }

    .status-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .status-dot.bad {
      background: #dc2626;
      box-shadow: 0 0 8px rgba(220, 38, 38, 0.7);
    }

    .hint {
      font-size: 11px;
      opacity: 0.6;
      margin-top: 4px;
    }

    .textarea {
      width: 100%;
      min-height: 72px;
      max-height: 180px;
      resize: vertical;
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-family: inherit;
      font-size: 13px;
    }

    .textarea:focus {
      outline: none;
      border-color: rgba(129, 140, 248, 0.9);
    }

    .cmd-status {
      font-size: 11px;
      margin-top: 6px;
      opacity: 0.8;
      white-space: pre-line;
    }

    .cmd-log {
      margin-top: 8px;
      font-family: "JetBrains Mono", ui-monospace;
      font-size: 11px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(55, 65, 81, 0.8);
      max-height: 160px;
      overflow: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header>
      <div class="brand">
        <span class="brand-title">Adnan.AI / Evolia OS</span>
        <span class="brand-subtitle">CEO konzola izvršnog direktora · Snimak sustava samo za čitanje</span>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="pill" id="version-pill">v–</span>
        <span class="pill" id="channel-pill">–</span>
      </div>
    </header>

    <main>
      <!-- SUSTAV -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">SUSTAV</span>
          <span class="badge" id="boot-badge">
            BOOTING
            <span class="status-dot bad"></span>
          </span>
        </div>
        <div id="system-kv"></div>
        <div class="hint">Ovdje izvršni direktor vidi stvarni status operativnog sustava (verzija, zaključaj, stanje).</div>
      </section>

      <!-- IDENTITET I MODA -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">IDENTITET I MODA</span>
        </div>
        <div id="identity-block"></div>
        <div id="mode-block" style="margin-top:10px;"></div>
      </section>

      <!-- CJEVO VOD ODOBRENJA -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">CJEVO VOD ODOBRENJA</span>
          <span class="badge">BLOKIRANO → ODOBRENO → IZVRŠENO</span>
        </div>
        <div id="approvals-stats"></div>
      </section>

      <!-- CEO KOMANDA (NL → /api/execute) -->
      <section class="card">
        <div class="card-header">
          <span class="card-title">CEO NL KOMANDA</span>
          <span class="badge-danger">GOVERNANCE ACTIVE</span>
        </div>
        <textarea
          id="ceo-input"
          class="textarea"
          placeholder="Upiši CEO komandu, npr: &#10;kreiraj task EVO-CEO-TASK-UI-001 priority High status Not Started due date 2026-01-15">
        </textarea>
        <div class="toolbar" style="justify-content:flex-start;margin-top:8px;">
          <button id="send-btn">Pošalji komandu (BLOCKED)</button>
          <button id="approve-btn">Odobri zadnji zahtjev</button>
          <button id="snapshot-btn">Osvježi snimku</button>
        </div>
        <div id="cmd-status" class="cmd-status"></div>
        <div id="cmd-log" class="cmd-log"></div>
        <div class="hint">
          UX ne preskače governance: svaka komanda ide CEO → BLOCKED → ODOBRENJE → EXECUTED.
        </div>
      </section>

      <!-- NEOBRAĐENI SNIMAK -->
      <section class="card" style="grid-column: span 2;">
        <div class="card-header">
          <span class="card-title">NEOBRAĐENI SNIMAK (OTKLANJANJE GREŠAKA)</span>
          <div class="toolbar" style="margin-bottom:0;">
            <button id="refresh-btn">Osvježi snimku</button>
          </div>
        </div>
        <div id="json-view" class="json-view">{}</div>
      </section>
    </main>
  </div>

  <script>
    let lastApprovalId = null;
    let lastExecutionId = null;

    function safeString(v) {
      if (v === null || v === undefined) return "–";
      return String(v);
    }

    async function loadSnapshot() {
      const jsonView = document.getElementById("json-view");
      const systemKv = document.getElementById("system-kv");
      const identityBlock = document.getElementById("identity-block");
      const modeBlock = document.getElementById("mode-block");
      const approvalsStats = document.getElementById("approvals-stats");
      const versionPill = document.getElementById("version-pill");
      const channelPill = document.getElementById("channel-pill");
      const bootBadge = document.getElementById("boot-badge");

      jsonView.textContent = "Učitavam snimku…";

      try {
        const res = await fetch("/api/ceo/console/snapshot");
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        jsonView.textContent = JSON.stringify(data, null, 2);

        const system = data.system || {};
        const identity = data.identity || {};
        const mode = data.mode || {};
        const approvals = data.approvals || {};

        versionPill.textContent = `v${safeString(system.version)}`;
        channelPill.textContent = safeString(system.release_channel);

        const bootOk = !!system.boot_ready;
        bootBadge.innerHTML = bootOk
          ? 'SPREMAN<span class="status-dot ok"></span>'
          : 'BOOTING<span class="status-dot bad"></span>';

        systemKv.innerHTML = "";
        const kvPairs = [
          ["Ime", system.name],
          ["Verzija", system.version],
          ["Kanal izdanja", system.release_channel],
          ["Luk brava", String(system.arch_lock)],
          ["Omogućen OS", String(system.os_enabled)],
          ["OPS siguran način rada", String(system.ops_safe_mode)],
        ];
        kvPairs.forEach(([k, v]) => {
          const row = document.createElement("div");
          row.className = "kv-row";
          row.innerHTML = `<span class="kv-key">${k}</span><span class="kv-value">${safeString(v)}</span>`;
          systemKv.appendChild(row);
        });

        identityBlock.innerHTML = "";
        const name = identity.name || "Adnan.AI";
        const role = identity.role || "";
        const essence = identity.essence || "";

        const titleRow = document.createElement("div");
        titleRow.className = "kv-row";
        titleRow.innerHTML = `<span class="kv-key">Identitet</span><span class="kv-value">${name}</span>`;
        identityBlock.appendChild(titleRow);

        if (role) {
          const roleRow = document.createElement("div");
          roleRow.className = "kv-row";
          roleRow.innerHTML = `<span class="kv-key">Uloge</span><span class="kv-value">${role}</span>`;
          identityBlock.appendChild(roleRow);
        }

        if (essence) {
          const essRow = document.createElement("div");
          essRow.style.marginTop = "6px";
          essRow.style.fontSize = "11px";
          essRow.style.opacity = "0.8";
          essRow.textContent = essence;
          identityBlock.appendChild(essRow);
        }

        const values = Array.isArray(identity.values) ? identity.values : [];
        if (values.length > 0) {
          const chipsRow = document.createElement("div");
          chipsRow.className = "list-chip-row";
          values.forEach(v => {
            const chip = document.createElement("span");
            chip.className = "chip chip-soft";
            chip.textContent = v;
            chipsRow.appendChild(chip);
          });
          identityBlock.appendChild(chipsRow);
        }

        modeBlock.innerHTML = "";
        const currentMode = (data.state && data.state.current_mode) || mode.default_mode || "operativni";
        const modeRow = document.createElement("div");
        modeRow.className = "kv-row";
        modeRow.innerHTML = `<span class="kv-key">Trenutni način rada</span><span class="kv-value">${currentMode}</span>`;
        modeBlock.appendChild(modeRow);

        const modes = mode.modes || {};
        const modeKeys = Object.keys(modes);
        if (modeKeys.length > 0) {
          const chipsRow = document.createElement("div");
          chipsRow.className = "list-chip-row";
          modeKeys.forEach(key => {
            const chip = document.createElement("span");
            chip.className = "chip";
            chip.textContent = key;
            chipsRow.appendChild(chip);
          });
          modeBlock.appendChild(chipsRow);
        }

        approvalsStats.innerHTML = "";
        const total = approvals.total ?? 0;
        const pendingCount = approvals.pending_count ?? 0;
        const completedCount = approvals.completed_count ?? 0;
        const failedCount = approvals.failed_count ?? 0;

        const grid = document.createElement("div");
        grid.className = "approvals-grid";

        [
          ["Ukupno", total],
          ["Na čekanju", pendingCount],
          ["Završeno", completedCount],
          ["Neuspješno", failedCount],
        ].forEach(([label, value]) => {
          const pill = document.createElement("div");
          pill.className = "stat-pill";
          pill.innerHTML = `<div class="stat-label">${label}</div><div class="stat-value">${value}</div>`;
          grid.appendChild(pill);
        });

        approvalsStats.appendChild(grid);
      } catch (err) {
        jsonView.textContent = "Greška pri učitavanju snimke: " + err;
      }
    }

    async function sendCommand() {
      const input = document.getElementById("ceo-input");
      const statusEl = document.getElementById("cmd-status");
      const logEl = document.getElementById("cmd-log");
      const text = (input.value || "").trim();
      if (!text) {
        statusEl.textContent = "Unesi CEO komandu.";
        return;
      }

      statusEl.textContent = "Šaljem /api/execute…";
      logEl.textContent = "";

      try {
        const res = await fetch("/api/execute", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text }),
        });

        if (!res.ok) {
          const errText = await res.text();
          statusEl.textContent = "Greška: " + errText;
          return;
        }

        const data = await res.json();
        lastApprovalId = data.approval_id || null;
        lastExecutionId = data.execution_id || null;

        statusEl.textContent =
          "STATUS: " + data.execution_state +
          "\napproval_id: " + safeString(lastApprovalId) +
          "\nexecution_id: " + safeString(lastExecutionId);

        logEl.textContent = JSON.stringify(data, null, 2);

        await loadSnapshot();
      } catch (err) {
        statusEl.textContent = "Greška pri slanju komande: " + err;
      }
    }

    async function approveLast() {
      const statusEl = document.getElementById("cmd-status");
      const logEl = document.getElementById("cmd-log");

      if (!lastApprovalId) {
        statusEl.textContent = "Nema aktivnog approval_id za odobriti (prvo pošalji komandu).";
        return;
      }

      statusEl.textContent = "Šaljem /api/ai-ops/approval/approve…";

      try {
        const res = await fetch("/api/ai-ops/approval/approve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ approval_id: lastApprovalId }),
        });

        if (!res.ok) {
          const errText = await res.text();
          statusEl.textContent = "Greška pri odobravanju: " + errText;
          return;
        }

        const data = await res.json();
        statusEl.textContent =
          "ODOBRENO.\nexecution_state: " + safeString(data.execution_state);
        logEl.textContent = JSON.stringify(data, null, 2);

        lastApprovalId = null; // ovaj je završen
        await loadSnapshot();
      } catch (err) {
        statusEl.textContent = "Greška pri odobravanju: " + err;
      }
    }

    document.getElementById("send-btn").addEventListener("click", sendCommand);
    document.getElementById("approve-btn").addEventListener("click", approveLast);
    document.getElementById("refresh-btn").addEventListener("click", loadSnapshot);
    document.getElementById("snapshot-btn").addEventListener("click", loadSnapshot);

    loadSnapshot();
  </script>
</body>
</html>
