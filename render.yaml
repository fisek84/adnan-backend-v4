services:
  # ============================
  # WEB API (uvicorn)
  # ============================
  - type: web
    name: adnan-backend-v4
    env: docker
    plan: starter
    region: frankfurt
    autoDeploy: true

    dockerfilePath: Dockerfile
    dockerContext: .

    # NOTE: na free/starter planu Render može ignorisati preDeployCommand; zato migracije radimo preko cron-a (vidi ispod).
    preDeployCommand: "alembic upgrade head"

    healthCheckPath: "/ready"
    healthCheckInterval: 30
    healthCheckTimeout: 10

    numInstances: 1

    resources:
      cpu: 0.5
      memory: 512Mi

    envVars:
      - key: RENDER
        value: "true"

      - key: DATABASE_URL
        sync: false

      - key: OPENAI_API_KEY
        sync: false

      - key: NOTION_API_KEY
        sync: false
      - key: NOTION_GOALS_DB_ID
        sync: false
      - key: NOTION_TASKS_DB_ID
        sync: false
      - key: NOTION_PROJECTS_DB_ID
        sync: false

      - key: NOTION_OPS_ASSISTANT_ID
        sync: false

      - key: AGENTS_JSON_PATH
        value: "/app/config/agents.json"

      - key: OPS_SAFE_MODE
        value: "false"
      - key: CEO_TOKEN_ENFORCEMENT
        value: "false"

      - key: OS_ENABLED
        value: "true"

    buildFilter:
      paths:
        - Dockerfile
        - requirements.txt
        - render.yaml
        - main.py
        - gateway/**
        - routers/**
        - services/**
        - models/**
        - ext/**
        - dependencies.py
        - config/**

    autoRetry:
      enabled: true
      maxRetries: 5
      delay: 10
      factor: 2

  # ============================
  # CRON (OFL periodic scheduler)
  # ============================
  - type: cron
    name: adnan-backend-v4-ofl-scheduler
    env: docker
    plan: starter
    region: frankfurt
    autoDeploy: true

    dockerfilePath: Dockerfile
    dockerContext: .

    # svaka 15 minuta (promijeni po potrebi)
    schedule: "*/15 * * * *"

    # ✅ Bez Shell-a: prvo migracije, pa onda scheduler
    command: "alembic upgrade head && python -m jobs.ofl_scheduler"

    envVars:
      - key: RENDER
        value: "true"

      - key: DATABASE_URL
        sync: false

      - key: OPENAI_API_KEY
        sync: false

      - key: NOTION_API_KEY
        sync: false
      - key: NOTION_GOALS_DB_ID
        sync: false
      - key: NOTION_TASKS_DB_ID
        sync: false
      - key: NOTION_PROJECTS_DB_ID
        sync: false

      - key: NOTION_OPS_ASSISTANT_ID
        sync: false

      - key: AGENTS_JSON_PATH
        value: "/app/config/agents.json"

      - key: OPS_SAFE_MODE
        value: "false"
      - key: CEO_TOKEN_ENFORCEMENT
        value: "false"

      - key: OS_ENABLED
        value: "true"
