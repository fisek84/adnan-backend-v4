openapi: "3.0.3"

info:
  title: "Evolia Backend v4"
  version: "4.2.0"
  description: >
    Public API contract for Evolia Backend v4.
    This API is deterministic, governed, and human-controlled.
    No autonomous execution is performed without explicit approval.

servers:
  - url: "https://adnan-backend-v4.onrender.com"
    description: "Production server"

tags:
  - name: Goals
    description: "Goal management (CRUD)"
  - name: Tasks
    description: "Task management (CRUD)"
  - name: Sync
    description: "One-way sync operations"
  - name: AI
    description: "Governed AI command execution"
  - name: AI Ops
    description: "Natural language ops (governed)"
  - name: Agents
    description: "Direct agent execution (controlled)"
  - name: Notion Ops
    description: "Structured Notion operations"

paths:

  ############################################################
  # GOALS — READ / WRITE (EXPLICIT)
  ############################################################
  /goals/all:
    get:
      summary: "Get all goals (READ)"
      tags: [Goals]
      operationId: "getAllGoals"
      responses:
        "200":
          description: "Goals list"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GoalResponse"

  /goals/create:
    post:
      summary: "Create a goal (WRITE)"
      tags: [Goals]
      operationId: "createGoal"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoalCreate"
      responses:
        "200":
          description: "Goal created"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoalResponse"

  /goals/{goal_id}:
    patch:
      summary: "Update a goal (WRITE)"
      tags: [Goals]
      operationId: "updateGoal"
      parameters:
        - name: goal_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoalUpdate"
      responses:
        "200":
          description: "Goal updated"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoalResponse"

    delete:
      summary: "Delete a goal (WRITE)"
      tags: [Goals]
      operationId: "deleteGoal"
      parameters:
        - name: goal_id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: "Goal deleted"

  ############################################################
  # TASKS — READ / WRITE
  ############################################################
  /tasks/all:
    get:
      summary: "Get all tasks (READ)"
      tags: [Tasks]
      operationId: "getAllTasks"
      responses:
        "200":
          description: "Tasks list"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskResponse"

  /tasks/create:
    post:
      summary: "Create a task (WRITE)"
      tags: [Tasks]
      operationId: "createTask"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreate"
      responses:
        "200":
          description: "Task created"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /tasks/{task_id}:
    patch:
      summary: "Update a task (WRITE)"
      tags: [Tasks]
      operationId: "updateTask"
      parameters:
        - name: task_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskUpdate"
      responses:
        "200":
          description: "Task updated"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

    delete:
      summary: "Delete a task (WRITE)"
      tags: [Tasks]
      operationId: "deleteTask"
      parameters:
        - name: task_id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: "Task deleted"

  ############################################################
  # AI COMMANDS — GOVERNED EXECUTION
  ############################################################
  /ai/run:
    post:
      summary: "Run AI command (GOVERNED)"
      tags: [AI]
      operationId: "runAiCommand"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AIRequest"
      responses:
        "200":
          description: "AI execution result (may require approval)"
          content:
            application/json:
              schema:
                type: object

  ############################################################
  # AGENTS — DIRECT EXECUTION (CONTROLLED)
  ############################################################
  /ext/agents/message:
    post:
      summary: "Send message to agent (EXECUTION)"
      tags: [Agents]
      operationId: "messageAgent"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agent, payload]
              properties:
                agent: { type: string }
                payload: { type: object }
      responses:
        "200":
          description: "Agent execution result"
          content:
            application/json:
              schema:
                type: object

  ############################################################
  # NOTION OPS — STRUCTURED, GOVERNED
  ############################################################
  /ext/notion-ops/execute:
    post:
      summary: "Execute structured Notion Ops command (GOVERNED)"
      tags: [Notion Ops]
      operationId: "notionOpsExecute"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [command]
              properties:
                command: { type: string }
                payload: { type: object }
      responses:
        "200":
          description: "Notion Ops execution result"
          content:
            application/json:
              schema:
                type: object

############################################################
# COMPONENTS
############################################################
components:
  schemas:

    GoalResponse:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string }
        progress: { type: integer }
        children:
          type: array
          items: { type: string }

    GoalCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }

    GoalUpdate:
      type: object
      properties:
        title: { type: string, nullable: true }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string, nullable: true }
        progress: { type: integer, nullable: true }

    TaskResponse:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        description: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string }
        order: { type: integer }

    TaskCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }

    TaskUpdate:
      type: object
      properties:
        title: { type: string, nullable: true }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string, nullable: true }
        order: { type: integer, nullable: true }

    AIRequest:
      type: object
      required: [command]
      properties:
        command: { type: string }
        payload: { type: object, nullable: true }
