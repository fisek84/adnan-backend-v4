openapi: "3.0.3"

info:
  title: "Evolia Backend v4"
  version: "4.2.0"
  description: >
    Public API contract for Evolia Backend v4.
    This API is deterministic, governed, and human-controlled.
    No autonomous execution is performed without explicit approval.

servers:
  - url: "https://adnan-backend-v4.onrender.com"
    description: "Production server"

tags:
  - name: Goals
    description: "Goal management (CRUD)"
  - name: Tasks
    description: "Task management (CRUD)"
  - name: Sync
    description: "One-way sync operations"
  - name: AI
    description: "Governed AI command execution"
  - name: AI Ops
    description: "Natural language ops (governed)"
  - name: Agents
    description: "Direct agent execution (controlled)"
  - name: Notion Ops
    description: "Structured Notion operations"

paths:

  ############################################################
  # GOALS — READ / WRITE
  ############################################################
  /api/goals/all:
    get:
      summary: "Get all goals (READ)"
      tags: [Goals]
      operationId: "getAllGoals"
      responses:
        "200":
          description: "Goals list"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/GoalResponse"

  /api/goals:
    post:
      summary: "Create a goal (WRITE)"
      tags: [Goals]
      operationId: "createGoal"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoalCreate"
      responses:
        "200":
          description: "Goal created"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoalResponse"

  /api/goals/{goal_id}:
    patch:
      summary: "Update a goal (WRITE)"
      tags: [Goals]
      operationId: "updateGoal"
      parameters:
        - name: goal_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/GoalUpdate"
      responses:
        "200":
          description: "Goal updated"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoalResponse"

    delete:
      summary: "Delete a goal (WRITE)"
      tags: [Goals]
      operationId: "deleteGoal"
      parameters:
        - name: goal_id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: "Goal deleted"

  ############################################################
  # TASKS — READ / WRITE
  ############################################################
  /api/tasks/all:
    get:
      summary: "Get all tasks (READ)"
      tags: [Tasks]
      operationId: "getAllTasks"
      responses:
        "200":
          description: "Tasks list"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/TaskResponse"

  /api/tasks/create:
    post:
      summary: "Create a task (WRITE)"
      tags: [Tasks]
      operationId: "createTask"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskCreate"
      responses:
        "200":
          description: "Task created"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

  /api/tasks/{task_id}:
    patch:
      summary: "Update a task (WRITE)"
      tags: [Tasks]
      operationId: "updateTask"
      parameters:
        - name: task_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TaskUpdate"
      responses:
        "200":
          description: "Task updated"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TaskResponse"

    delete:
      summary: "Delete a task (WRITE)"
      tags: [Tasks]
      operationId: "deleteTask"
      parameters:
        - name: task_id
          in: path
          required: true
          schema: { type: string }
      responses:
        "200":
          description: "Task deleted"

  ############################################################
  # SYNC — ONE-WAY (READ-ONLY)
  ############################################################
  /api/sync/status:
    get:
      summary: "Sync service status"
      tags: [Sync]
      operationId: "syncStatus"
      responses:
        "200":
          description: "Sync status"
          content:
            application/json:
              schema:
                type: object

  /api/sync/goals:
    post:
      summary: "Sync goals"
      tags: [Sync]
      operationId: "syncGoals"
      responses:
        "200":
          description: "Sync result"
          content:
            application/json:
              schema:
                type: object

  /api/sync/tasks:
    post:
      summary: "Sync tasks"
      tags: [Sync]
      operationId: "syncTasks"
      responses:
        "200":
          description: "Sync result"
          content:
            application/json:
              schema:
                type: object

  /api/sync/projects:
    post:
      summary: "Sync projects"
      tags: [Sync]
      operationId: "syncProjects"
      responses:
        "200":
          description: "Sync result"
          content:
            application/json:
              schema:
                type: object

  /api/sync/full:
    post:
      summary: "Sync full"
      tags: [Sync]
      operationId: "syncFull"
      responses:
        "200":
          description: "Sync result"
          content:
            application/json:
              schema:
                type: object

  ############################################################
  # AI (READ-ONLY)
  ############################################################
  /api/ai/run:
    post:
      summary: "Run AI command (READ-ONLY / GOVERNED)"
      tags: [AI]
      operationId: "runAiCommand"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [text]
              properties:
                text: { type: string }
                snapshot: { type: object, nullable: true }
                metadata: { type: object, nullable: true }
      responses:
        "200":
          description: "AI execution result"
          content:
            application/json:
              schema:
                type: object

  /api/chat:
    post:
      summary: "Canonical chat (READ-ONLY; never-empty snapshot)"
      tags: [AI]
      operationId: "chat"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message: { type: string }
                snapshot: { type: object, nullable: true }
                metadata: { type: object, nullable: true }
                session_id: { type: string, nullable: true }
      responses:
        "200":
          description: "Chat output"
          content:
            application/json:
              schema:
                type: object

  /api/ceo/command:
    post:
      summary: "CEO command (READ-ONLY; propose-only)"
      tags: [AI]
      operationId: "ceoCommand"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                input_text: { type: string, nullable: true }
                text: { type: string, nullable: true }
                message: { type: string, nullable: true }
                session_id: { type: string, nullable: true }
      responses:
        "200":
          description: "CEO command output"
          content:
            application/json:
              schema:
                type: object

  ############################################################
  # CEO CONSOLE
  ############################################################
  /api/ceo/console/snapshot:
    get:
      summary: "CEO Console snapshot (never-empty)"
      tags: [AI]
      operationId: "ceoConsoleSnapshot"
      responses:
        "200":
          description: "Snapshot"
          content:
            application/json:
              schema:
                type: object

  ############################################################
  # EXECUTE (GOVERNED)
  ############################################################
  /api/execute/raw:
    post:
      summary: "Create execution (approval-gated) or run refresh_snapshot"
      tags: [AI Ops]
      operationId: "executeRaw"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: "Execution result"
          content:
            application/json:
              schema:
                type: object

  /api/execute/preview:
    post:
      summary: "Preview execution (read-only)"
      tags: [AI Ops]
      operationId: "executePreview"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        "200":
          description: "Preview"
          content:
            application/json:
              schema:
                type: object

############################################################
# COMPONENTS
############################################################
components:
  schemas:

    GoalResponse:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string }
        progress: { type: integer }
        children:
          type: array
          items: { type: string }

    GoalCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }

    GoalUpdate:
      type: object
      properties:
        title: { type: string, nullable: true }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        parent_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string, nullable: true }
        progress: { type: integer, nullable: true }

    TaskResponse:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        description: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string }
        order: { type: integer }

    TaskCreate:
      type: object
      required: [title]
      properties:
        title: { type: string }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }

    TaskUpdate:
      type: object
      properties:
        title: { type: string, nullable: true }
        description: { type: string, nullable: true }
        deadline: { type: string, nullable: true }
        goal_id: { type: string, nullable: true }
        priority: { type: string, nullable: true }
        status: { type: string, nullable: true }
        order: { type: integer, nullable: true }

    AIRequest:
      type: object
      required: [command]
      properties:
        command: { type: string }
        payload: { type: object, nullable: true }
